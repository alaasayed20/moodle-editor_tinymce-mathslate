YUI.add("moodle-tinymce_mathslate-mathjaxeditor",function(e,t){M.tinymce_mathslate=M.tinymce_mathslate||{},NS=M&&M.tinymce_mathslate||{};var n={SELECTED:"mathslate-selected",WORKSPACE:"mathslate-workspace",PREVIEW:"mathslate-preview",HIGHLIGHT:"mathslate-highlight",DRAGNODE:"mathslate-workspace-drag",DRAGGEDNODE:"mathslate-workspace-dragged",HELPBOX:"mathslate-help-box",PANEL:"mathslate-bottom-panel"},r={SELECTED:"."+n.SELECTED,HIGHLIGHT:"."+n.HIGHLIGHT};NS.MathJaxEditor=function(t){function v(){o=e.Node.create('<span style="position: absolute; opacity: 0"></span>'),o.setHTML(s.preview().replace(/div/g,"span").replace(/<\/*br>/g,"")),e.one(t).appendChild(o),o.all("span").each(function(t){if(!l.get("node").one("#"+t.getAttribute("id")))return;t.appendChild('<math dislplay="inline">'+g([e.JSON.parse(s.getItemByID(t.getAttribute("id")))])+"</math>")}),MathJax.Hub.Queue(["Typeset",MathJax.Hub,o.getDOMNode()]),MathJax.Hub.Queue(function(){o.all("span").each(function(e){if(!l.get("node").one("#"+e.getAttribute("id")))return;var t=l.get("node").one("#"+e.getAttribute("id")).getDOMNode().getBoundingClientRect();e.setStyle("backgroundColor","blue"),e.setStyle("margin-left","-10px"),e.setStyle("padding","-5px"),e.setStyle("margin","0px"),e.setStyle("position","absolute"),e.setStyle("zIndex","+1"),e.setXY([t.left,t.top])})})}function m(){o&&o.remove(),l.get("node").one(".math")?u=l.get("node"):(v(),u=o),f.setHTML('<div class="'+n.PREVIEW+'">'+s.preview("tex")+"</div>"),s.getSelected()&&f.one("#"+s.getSelected())&&(l.get("node").one("#"+s.getSelected()).addClass(n.SELECTED),l.get("node").one("#"+s.getSelected()).setAttribute("mathcolor","green"),l.get("node").one("#"+s.getSelected()).setAttribute("stroke","green"),l.get("node").one("#"+s.getSelected()).setAttribute("fill","green"),f.one("#"+s.getSelected()).addClass(n.SELECTED)),s.forEach(function(t){var i=u.one("#"+t[1].id);if(!i)return;i.setAttribute("title",f.one("#"+t[1].id).getHTML().replace(/<div *[^>]*>|<\/div>|<br>/g,"")),i.handleClick=function(e){var t=u.one("#"+s.getSelected());if(!t){e.stopPropagation(),s.select(this.getAttribute("id")),y();return}if(t===i){i.removeClass(n.SELECTED),f.one("#"+i.getAttribute("id")).removeClass(n.SELECTED),l.get("node").one("#"+s.getSelected()).removeAttribute("mathcolor"),l.get("node").one("#"+s.getSelected()).removeAttribute("stroke"),l.get("node").one("#"+s.getSelected()).removeAttribute("fill"),s.select();return}if(t.one("#"+this.getAttribute("id")))return;e.stopPropagation(),s.insertSnippet(i.getAttribute("id"),s.removeSnippet(t.getAttribute("id"))),s.select(),y()},i.on("click",function(e){this.handleClick(e)});var o=u.one("#"+s.getSelected());if((!t[1]||!t[1]["class"]||t[1]["class"]!=="blank")&&(!o||!f.one("#"+s.getSelected()).one("#"+t[1].id))){var a=(new e.DD.Drag({node:i})).plug(e.Plugin.DDProxy,{resizeFrame:!1,moveOnEnd:!1});a.on("drag:start",function(){l.get("node").one("#"+s.getSelected())&&(f.one("#"+s.getSelected()).removeClass(n.SELECTED),l.get("node").one("#"+s.getSelected()).removeClass(n.SELECTED),l.get("node").one("#"+s.getSelected()).removeAttribute("mathcolor"),l.get("node").one("#"+s.getSelected()).removeAttribute("stroke"),l.get("node").one("#"+s.getSelected()).removeAttribute("fill"),s.select()),this.get("node").addClass(n.DRAGGEDNODE),this.get("node").setAttribute("mathcolor","red");var r=e.guid();this.get("dragNode").set("innerHTML","<math>"+g([e.JSON.parse(s.getItemByID(t[1].id))])+"</math>"),this.get("dragNode").addClass(n.DRAGNODE),MathJax.Hub.Queue(["Typeset",MathJax.Hub,r])}),a.on("drag:end",function(){this.get("node").removeClass(n.DRAGGEDNODE),this.get("node").removeAttribute("mathcolor","red")})}var c=new e.DD.Drop({node:i});c.on("drop:hit",function(e){var n=e.drag.get("node").get("id");e.drag.get("data")?s.insertSnippet(t[1].id,s.createItem(e.drag.get("data"))):n!==t[1].id&&s.isItem(n)&&!f.one("#"+n).one("#"+t[1].id)&&s.insertSnippet(e.drop.get("node").get("id"),s.removeSnippet(n)),y()}),c.on("drop:enter",function(e){e.stopPropagation(),l.get("node").all(r.HIGHLIGHT).each(function(e){e.removeClass(n.HIGHLIGHT)}),l.get("node").one("#"+t[1].id).addClass(n.HIGHLIGHT),l.get("node").one("#"+t[1].id).setAttribute("mathcolor","yellow"),l.get("node").one("#"+t[1].id).setAttribute("stroke","yellow"),l.get("node").one("#"+t[1].id).setAttribute("fill","yellow")}),c.on("drop:exit",function(e){e.stopPropagation(),this.get("node").removeClass(n.HIGHLIGHT),l.get("node").one("#"+t[1].id).removeClass(n.HIGHLIGHT),l.get("node").one("#"+t[1].id).removeAttribute("mathcolor"),l.get("node").one("#"+t[1].id).removeAttribute("stroke"),l.get("node").one("#"+t[1].id).removeAttribute("fill")})})}function g(e){if(typeof e!="object")return e;var t="";return e.forEach(function(e){var n;if(typeof e!="object")return;t+="<"+e[0];if(e[1]&&typeof e[1]=="object")for(n in e[1])typeof e[1][n]!="object"&&(t+=" "+n+'="'+e[1][n]+'"');t+=">",e[2]&&(t+=g(e[2])),t+="</"+e[0]+">"}),t}function y(){s.rekey();var e=MathJax.Hub.getAllJax("canvas")[0];e?MathJax.Hub.Queue(function(){MathJax.Hub.Queue(["Text",e,"<math>"+g(i)+"</math>"]),MathJax.Hub.Queue(m)}):(l.get("node").setHTML(""),MathJax.Hub.Queue(["addElement",MathJax.HTML,l.get("node").getDOMNode(),"math",{display:"block"},i]),MathJax.Hub.Queue(["Typeset",MathJax.Hub,"canvas"]),MathJax.Hub.Queue(m))}var i=[],s=new NS.mSlots;s.slots.push(i);var o,u;this.workspace=e.one(t).append('<div id="canvas" class="'+n.WORKSPACE+'"/>');var a=e.one(t).appendChild(e.Node.create("<form></form>")),f=e.one(t).appendChild(e.Node.create('<div class="'+n.PANEL+'"/>'));f.delegate("click",function(e){u.one("#"+this.getAttribute("id")).handleClick(e)},"div");var l=new e.DD.Drop({node:this.workspace.one("#canvas")});this.canvas=l,this.canvas.get("node").on("click",function(){s.select(),y()});var c=e.Node.create('<button type="button" class="'+n.UNDO+'"'+'" title="'+M.util.get_string("undo","tinymce_mathslate")+'"/>'+"<math><mo>&#x25C1;</mo></math>"+"</button>"),h=e.Node.create('<button type="button" class="'+
n.REDO+'"'+'" title="'+M.util.get_string("redo","tinymce_mathslate")+'"/>'+"<math><mo>&#x25B7;</mo></math>"+"</button>"),p=e.Node.create('<button type="button" class="'+n.CLEAR+'"'+'" title="'+M.util.get_string("clear","tinymce_mathslate")+'"/>'+"<math><mi>&#x2718;</mi></math>"+"</button>"),d=e.Node.create('<button type="button" class="'+n.HELP+'" title="'+M.util.get_string("help","tinymce_mathslate")+'">'+"<math><mi>&#xE47C;</mi></math>"+"</button>");a.appendChild(p),a.appendChild(c),a.appendChild(h),a.appendChild(d),h.on("click",function(){s=s.redo(),i=s.slots[0],y()}),c.on("click",function(){s=s.undo(),i=s.slots[0],y()}),p.on("click",function(){e.one(r.SELECTED)?s.removeSnippet(e.one(r.SELECTED).getAttribute("id")):(i=[],s.next=new NS.mSlots,s.next.previous=s,s=s.next,s.slots.push(i)),y()}),d.on("click",function(){f.setHTML('<iframe src="'+NS.help+'" style="width: '+f.getStyle("width")+'" class="'+n.HELPBOX+'"/>')}),this.render=y,this.addMath=function(t){if(!t)return;e.one(r.SELECTED)?s.insertSnippet(e.one(r.SELECTED).getAttribute("id"),s.createItem(t)):s.append(s.createItem(t)),y()},this.clear=function(){e.one(r.SELECTED)?s.removeSnippet(e.one(r.SELECTED).getAttribute("id")):(i=[],s.next=new NS.mSlots,s.next.previous=s,s=s.next,s.slots.push(i)),y()},this.output=function(t){function n(e){if(typeof e!="object")return e;var t=e.slice(0);return t.forEach(function(e,r){if(typeof e!="object")return;if(e[1]&&e[1]["class"]){t[r]="[]";return}e[1]&&e[1].id&&delete e[1].id,e[2]&&(e[2]=n(e[2]))}),t}return t==="MathML"?l.get("node").one("script").getHTML():t==="HTML"?l.get("node").one("span").getHTML():t==="JSON"?e.JSON.stringify(n(i)):s.output(t)},this.getHTML=function(){return l.get("node").one("span").getHTML()},this.redo=function(){s=s.redo(),i=s.slots[0],y()},this.undo=function(){s=s.undo(),i=s.slots[0],y()},this.makeDrops=function(){v()},y()}},"@VERSION@",{requires:["moodle-tinymce_mathslate-snippeteditor","dd-proxy","dd-drop"]});
