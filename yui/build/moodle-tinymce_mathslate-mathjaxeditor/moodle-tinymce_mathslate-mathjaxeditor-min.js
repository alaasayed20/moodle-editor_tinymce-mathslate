YUI.add("moodle-tinymce_mathslate-mathjaxeditor",function(e,t){M.tinymce_mathslate=M.tinymce_mathslate||{};var n=M&&M.tinymce_mathslate||{},r=window.MathJax,i=!0,s={SELECTED:"mathslate-selected",WORKSPACE:"mathslate-workspace",PREVIEW:"mathslate-preview",HIGHLIGHT:"mathslate-highlight",DRAGNODE:"mathslate-workspace-drag",DRAGGEDNODE:"mathslate-workspace-dragged",HELPBOX:"mathslate-help-box",PANEL:"mathslate-bottom-panel"},o={SELECTED:"."+s.SELECTED,HIGHLIGHT:"."+s.HIGHLIGHT},u,a;n.MathJaxEditor=function(t){r.Ajax.Require("[Mathslate]/snippeteditor.js"),this.workspace=e.one(t).getDOMNode(),this.init()},n.MathJaxEditor.prototype={init:function(){this.math=[],this.canvas=document.createElement("div"),this.canvas.id="canvas",this.canvas.setAttribute("class",s.WORKSPACE),this.workspace.appendChild(this.canvas),this.addToolbar();var t=e.one(this.workspace).appendChild(e.Node.create('<div class="'+s.PANEL+'"/>'));t.delegate("click",function(e){a.one("#"+this.getAttribute("id")).handleClick(e)},"div"),this.preview=t;var n=new e.DD.Drop({node:this.canvas});this.canvas=n,e.one(this.workspace).on("click",function(){this.se.select(),this.render()},this),r.Hub.Register.StartupHook("Snippet Editor Ready",[function(e){e.se=new r.Mathslate.mSlots,e.se.slots.push(e.math),e.render()},this])},render:function(){this.se.rekey();var e=r.Hub.getAllJax(this.workspace)[0];e?r.Hub.Queue(["Text",e,"<math>"+this.toMathML(this.math)+"</math>"]):(this.workspace.firstChild="",r.Hub.Queue(["addElement",r.HTML,this.workspace.firstChild,"math",{display:"block"},this.math]),r.Hub.Queue(["Typeset",r.Hub,this.workspace.firstChild])),r.Hub.Queue(["makeDraggable",this])},toMathML:function(e){if(typeof e!="object")return e;var t="";return e.forEach(function(e){var n;if(typeof e!="object")return;t+="<"+e[0];if(e[1]&&typeof e[1]=="object")for(n in e[1])typeof e[1][n]!="object"&&(t+=" "+n+'="'+e[1][n]+'"');t+=">",e[2]&&(t+=this.toMathML(e[2])),t+="</"+e[0]+">"},this),t},addMath:function(t){if(!t)return;e.one(this.workspace).one(o.SELECTED)?this.se.insertSnippet(e.one(this.workspace).one(o.SELECTED).getAttribute("id"),this.se.createItem(t)):this.se.append(this.se.createItem(t)),this.render()},clear:function(){e.one(this.workspace).one(o.SELECTED)?this.se.removeSnippet(e.one(this.workspace).one(o.SELECTED).getAttribute("id")):(this.math=[],this.se.next=new r.Mathslate.mSlots,this.se.next.previous=this.se,this.se=this.se.next,this.se.slots.push(this.math)),this.render()},output:function(t){function n(e){if(typeof e!="object")return e;var t=e.slice(0);return t.forEach(function(e,r){if(typeof e!="object")return;if(e[1]&&e[1]["class"]){t[r]="[]";return}e[1]&&e[1].id&&delete e[1].id,e[2]&&(e[2]=n(e[2]))}),t}switch(t){case"MathML":return e.one(this.workspace).one("script").getHTML();case"HTML":return e.one(this.workspace).one("span").getHTML();case"JSON":return e.JSON.stringify(n(this.math));default:return this.se.output(t)}},getHTML:function(){return this.workspace.firstChild.innerHTML},redo:function(){this.se=this.se.redo(),this.math=this.se.slots[0],this.render()},undo:function(){this.se=this.se.undo(),this.math=this.se.slots[0],this.render()},updatePreview:function(){this.preview.setHTML('<div class="'+s.PREVIEW+'">'+this.se.preview("tex")+"</div>"),this.se.getSelected()&&this.preview.one("#"+this.se.getSelected())&&(e.one(this.workspace).one("#"+this.se.getSelected()).addClass(s.SELECTED),e.one(this.workspace).one("#"+this.se.getSelected()).addClass(s.SELECTED).setAttribute("mathcolor","green").setAttribute("stroke","green").setAttribute("fill","green"),this.preview.one("#"+this.se.getSelected()).addClass(s.SELECTED))},setTitle:function(e){var t=a.one("#"+e[1].id);if(!t)return;t.setAttribute("expressionId",e[1].id),t.setAttribute("title",this.preview.one("#"+e[1].id).getHTML().replace(/<div *[^>]*>|<\/div>|<br>/g,"")),t.addClass("mathslate_dnd")},makeDraggable:function(){u&&u.remove(),this.makeDrops(),a=u,this.updatePreview();var e=this;this.se.forEach(function(t){e.setTitle(t)}),this.addListeners()},addListeners:function(){a.delegate("click",function(t){var n=a.one("#"+this.se.getSelected());if(!n){t.stopPropagation(),this.se.select(t.currentTarget.getAttribute("id")),this.render();return}if(n===t.currentTarget){if(this.preview.one("#"+t.currentTarget.getAttribute("id")).test("."+s.PREVIEW+" >")){this.se.select(),this.render();return}t.currentTarget.removeClass(s.SELECTED),this.preview.one("#"+t.currentTarget.getAttribute("id")).removeClass(s.SELECTED),e.one(this.workspace).one("#"+this.se.getSelected()).removeAttribute("mathcolor").removeAttribute("stroke").removeAttribute("fill"),this.se.select();return}if(n.one("#"+t.currentTarget.getAttribute("id")))return;t.stopPropagation(),this.se.insertSnippet(t.currentTarget.getAttribute("id"),this.se.removeSnippet(n.getAttribute("id"))),this.se.select(),this.render()},".mathslate_dnd",this),new e.DD.Delegate({container:a,moveOnEnd:!1,nodes:".mathslate_dnd"}),e.DD.DDM.on("drag:start",function(e){var t=e.target;t.get("node").hasClass("mathslate_dnd")&&(t.get("node").addClass(s.DRAGGEDNODE),t.get("dragNode").addClass(s.DRAGNODE),t.get("dragNode").all("> span").pop().setStyle("opacity","1"))}),e.DD.DDM.on("drag:end",function(e){var t=e.target;t.get("node").hasClass("mathslate_dnd")&&(t.get("node").removeClass(s.DRAGGEDNODE).removeAttribute("mathcolor").removeAttribute("stroke").setStyles({top:0,left:0}),t.get("dragNode").all("> span").pop().setStyle("opacity","0"),e.stopPropagation())},this),e.one(this.workspace).all(".mathslate_dnd").each(function(t){new e.DD.Drop({node:t})}),e.DD.DDM.on("drop:hit",function(e){if(!e.target.get("node").hasClass("mathslate_dnd"))return;var t=e.drag.get("node").get("id"),n=e.target.get("node").getAttribute("id");if(e.drag.get("data"))this.se.insertSnippet(n,this.se.createItem(e.drag.get("data")));else{if(t===n||!this.se.isItem(t)||!!this.preview.one("#"+t).one("#"+n))return;this.se.insertSnippet(e.drop.get("node").get("id"),this.se.removeSnippet(t))}e.stopPropagation
(),this.render()},this),e.DD.DDM.on("drop:enter",function(t){if(!t.target.get("node").hasClass("mathslate_dnd"))return;t.stopPropagation();var n=t.target.get("node").getAttribute("id");e.one(this.workspace).all(o.HIGHLIGHT).removeAttribute("mathcolor").removeAttribute("stroke").removeAttribute("fill").removeClass(s.HIGHLIGHT),a.all(o.HIGHLIGHT).removeClass(s.HIGHLIGHT),a.one("#"+n)&&a.one("#"+n).addClass(s.HIGHLIGHT),e.one(this.workspace).one("#"+n).addClass(s.HIGHLIGHT),e.one(this.workspace).one("#"+n).setAttribute("mathcolor","yellow").setAttribute("stroke","yellow").setAttribute("fill","yellow")},this),e.DD.DDM.on("drop:exit",function(t){if(!t.target.get("node")||!t.target.get("node").hasClass("mathslate_dnd"))return;var n=t.target.get("node").getAttribute("id");e.one(this.workspace).one("#"+n).test(s.HIGHLIGHT)?(e.one(this.workspace).one("#"+n).removeAttribute("mathcolor").removeAttribute("stroke").removeAttribute("fill").removeClass(s.HIGHLIGHT),t.target.get("node").removeClass(s.HIGHLIGHT),e.one(this.workspace).all("#"+n+"[stroke=yellow]").removeAttribute("fill").removeAttribute("stroke"),e.one(this.workspace).all("#"+n+"[mathcolor=yellow]").removeAttribute("mathcolor")):(t.target.get("node").addClass(s.HIGHLIGHT),e.one(this.workspace).one("#"+n).setAttribute("mathcolor","yellow").setAttribute("stroke","yellow").setAttribute("fill","yellow").addClass(s.HIGHLIGHT),t.stopPropagation())},this)},YUImakeDrops:function(){u=e.Node.create("<span></span>"),u.setHTML(this.se.preview().replace(/div/g,"span").replace(/<\/*br>/g,"")),e.one(this.workspace).appendChild(u),u.all("span").each(function(t){if(!e.one(this.workspace).one("#"+t.getAttribute("id")))return;t.appendChild('<span style="position: relative; opacity: 0"><math display="inline">'+this.toMathML([e.JSON.parse(this.se.getItemByID(t.getAttribute("id")))]).replace(/id="[^"]*"/,"")+"</math></span>"),t.setAttribute("style","position: absolute; top: 0; left: 0; margin: 0px; z-index: +1")},this),u.all("span").each(function(t){if(!e.one(this.workspace).one("#"+t.getAttribute("id")))return;var n=e.one(this.workspace).one("#"+t.getAttribute("id")).getDOMNode().getBoundingClientRect(),r=t.getDOMNode().getBoundingClientRect();t.setStyle("top",n.top-r.top),t.setStyle("left",n.left-r.left),t.setStyle("width",n.width),t.setStyle("height",n.height)}),r.Hub.Queue(["Typeset",r.Hub,u.getDOMNode()])},makeDrops:function(){u=document.createElement("span"),u.innerHTML=this.se.preview().replace(/div/g,"span").replace(/<\/*br>/g,""),this.workspace.appendChild(u);var t=u.getElementsByTagName("span");for(var n=0;n<t.length;n++){var i=t.item(n);if(e.one(this.workspace).one("#"+i.id)){var s=document.createElement("span");s.setAttribute("style","position: relative; opacity: 0"),s.innerHTML='<math display="inline">'+this.toMathML([e.JSON.parse(this.se.getItemByID(i.getAttribute("id")))]).replace(/id="[^"]*"/,"")+"</math>",i.appendChild(s),i.setAttribute("style","position: absolute; top: 4.75px; left: 1.25px; margin: 0px; z-index: +1");var o=e.one(this.workspace).one("#"+i.id).getDOMNode().getBoundingClientRect(),a=i.getBoundingClientRect();i.setAttribute("style","position: absolute; top: "+(o.top-a.top).toString()+"px; left: "+(o.left-a.left).toString()+"px; z-index: +1")}}r.Hub.Queue(["Typeset",r.Hub,u]),u=e.one(u)},addToolbar:function(){var t=document.createElement("button");t.type="button",t.title=M.util.get_string("redo","tinymce_mathslate"),t["class"]=s.UNDO,t.innerHTML="<math><mo>&#x25C1;</mo></math>",t=e.one(t);var r=document.createElement("button");r.type="button",r.title=M.util.get_string("redo","tinymce_mathslate"),r["class"]=s.REDO,r.innerHTML="<math><mo>&#x25B7;</mo></math>",r=e.one(r);var i=document.createElement("button");i.type="button",i.title=M.util.get_string("clear","tinymce_mathslate"),i["class"]=s.CLEAR,i.innerHTML="<math><mi>&#x2718;</mi></math>",i=e.one(i);var o=document.createElement("button");o.type="button",o.title=M.util.get_string("help","tinymce_mathslate"),o["class"]=s.HELP,o.innerHTML="<math><mi>&#xE47C;</mi></math>",o=e.one(o),this.toolbar=e.one(this.workspace).appendChild(e.Node.create("<form></form>")),this.toolbar.appendChild(i),this.toolbar.appendChild(t),this.toolbar.appendChild(r),this.toolbar.appendChild(o),r.on("click",this.redo,this),t.on("click",this.undo,this),i.on("click",this.clear,this),o.on("click",function(){this.preview.setHTML('<iframe src="'+n.help+'" style="width: '+this.preview.getStyle("width")+'" class="'+s.HELPBOX+'"/>')},this)}}},"@VERSION@",{requires:["drag-delegate","dd-drop"]});
