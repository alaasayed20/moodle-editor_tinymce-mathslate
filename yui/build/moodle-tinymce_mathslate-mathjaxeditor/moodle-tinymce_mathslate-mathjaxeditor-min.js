YUI.add("moodle-tinymce_mathslate-mathjaxeditor",function(e,t){M.tinymce_mathslate=M.tinymce_mathslate||{};var n=M&&M.tinymce_mathslate||{},r=window.MathJax,i=!0,s={SELECTED:"mathslate-selected",WORKSPACE:"mathslate-workspace",PREVIEW:"mathslate-preview",HIGHLIGHT:"mathslate-highlight",DRAGNODE:"mathslate-workspace-drag",DRAGGEDNODE:"mathslate-workspace-dragged",HELPBOX:"mathslate-help-box",PANEL:"mathslate-bottom-panel"},o={SELECTED:"."+s.SELECTED,HIGHLIGHT:"."+s.HIGHLIGHT};n.MathJaxEditor=function(t){r.Ajax.Require("[Mathslate]/snippeteditor.js"),this.math=[];var i,u,a;this.workspace=e.one(t).append('<div id="canvas" class="'+s.WORKSPACE+'"/>'),this.toolbar=e.one(t).appendChild(e.Node.create("<form></form>"));var f=e.one(t).appendChild(e.Node.create('<div class="'+s.PANEL+'"/>'));f.delegate("click",function(e){a.one("#"+this.getAttribute("id")).handleClick(e)},"div");var l=new e.DD.Drop({node:this.workspace.one("#canvas")});this.canvas=l,this.canvas.get("node").on("click",function(){i.select(),this.render()},this);var c=document.createElement("button");c.type="button",c.title=M.util.get_string("redo","tinymce_mathslate"),c["class"]=s.UNDO,c.innerHTML="<math><mo>&#x25C1;</mo></math>",c=e.one(c);var h=document.createElement("button");h.type="button",h.title=M.util.get_string("redo","tinymce_mathslate"),h["class"]=s.REDO,h.innerHTML="<math><mo>&#x25B7;</mo></math>",h=e.one(h);var p=document.createElement("button");p.type="button",p.title=M.util.get_string("clear","tinymce_mathslate"),p["class"]=s.CLEAR,p.innerHTML="<math><mi>&#x2718;</mi></math>",p=e.one(p);var d=document.createElement("button");d.type="button",d.title=M.util.get_string("help","tinymce_mathslate"),d["class"]=s.HELP,d.innerHTML="<math><mi>&#xE47C;</mi></math>",d=e.one(d),this.toolbar.appendChild(p),this.toolbar.appendChild(c),this.toolbar.appendChild(h),this.toolbar.appendChild(d),this.render=function(){i.rekey();var e=r.Hub.getAllJax(l.get("node").getDOMNode())[0];e?r.Hub.Queue(["Text",e,"<math>"+this.toMathML(this.math)+"</math>"]):(l.get("node").setHTML(""),r.Hub.Queue(["addElement",r.HTML,l.get("node").getDOMNode(),"math",{display:"block"},this.math]),r.Hub.Queue(["Typeset",r.Hub,l.get("node").getDOMNode()])),r.Hub.Queue(["makeDraggable",this])},this.toMathML=function(e){if(typeof e!="object")return e;var t="";return e.forEach(function(e){var n;if(typeof e!="object")return;t+="<"+e[0];if(e[1]&&typeof e[1]=="object")for(n in e[1])typeof e[1][n]!="object"&&(t+=" "+n+'="'+e[1][n]+'"');t+=">",e[2]&&(t+=this.toMathML(e[2])),t+="</"+e[0]+">"},this),t},this.addMath=function(n){if(!n)return;e.one(t+" "+o.SELECTED)?i.insertSnippet(e.one(t+" "+o.SELECTED).getAttribute("id"),i.createItem(n)):i.append(i.createItem(n)),this.render()},this.clear=function(){e.one(t+" "+o.SELECTED)?i.removeSnippet(e.one(t+" "+o.SELECTED).getAttribute("id")):(this.math=[],i.next=new r.Mathslate.mSlots,i.next.previous=i,i=i.next,i.slots.push(this.math)),this.render()},this.output=function(t){function n(e){if(typeof e!="object")return e;var t=e.slice(0);return t.forEach(function(e,r){if(typeof e!="object")return;if(e[1]&&e[1]["class"]){t[r]="[]";return}e[1]&&e[1].id&&delete e[1].id,e[2]&&(e[2]=n(e[2]))}),t}switch(t){case"MathML":return l.get("node").one("script").getHTML();case"HTML":return l.get("node").one("span").getHTML();case"JSON":return e.JSON.stringify(n(this.math));default:return i.output(t)}},this.getHTML=function(){return l.get("node").one("span").getHTML()},this.redo=function(){i=i.redo(),this.math=i.slots[0],this.render()},this.undo=function(){i=i.undo(),this.math=i.slots[0],this.render()},this.updatePreview=function(){f.setHTML('<div class="'+s.PREVIEW+'">'+i.preview("tex")+"</div>"),i.getSelected()&&f.one("#"+i.getSelected())&&(l.get("node").one("#"+i.getSelected()).addClass(s.SELECTED),l.get("node").one("#"+i.getSelected()).setAttribute("mathcolor","green"),l.get("node").one("#"+i.getSelected()).setAttribute("stroke","green"),l.get("node").one("#"+i.getSelected()).setAttribute("fill","green"),f.one("#"+i.getSelected()).addClass(s.SELECTED))},this.setTitle=function(e){var t=a.one("#"+e[1].id);if(!t)return;t.setAttribute("expressionId",e[1].id),t.setAttribute("title",f.one("#"+e[1].id).getHTML().replace(/<div *[^>]*>|<\/div>|<br>/g,"")),t.addClass("mathslate_dnd")},this.makeDraggable=function(){u&&u.remove(),this.makeDrops(),a=u,this.updatePreview(),i.forEach(this.setTitle),this.addListeners()},this.addListeners=function(){a.delegate("click",function(e){var t=a.one("#"+i.getSelected());if(!t){e.stopPropagation(),i.select(e.currentTarget.getAttribute("id")),this.render();return}if(t===e.currentTarget){if(f.one("#"+e.currentTarget.getAttribute("id")).test("."+s.PREVIEW+" >")){i.select(),this.render();return}e.currentTarget.removeClass(s.SELECTED),f.one("#"+e.currentTarget.getAttribute("id")).removeClass(s.SELECTED),l.get("node").one("#"+i.getSelected()).removeAttribute("mathcolor"),l.get("node").one("#"+i.getSelected()).removeAttribute("stroke"),l.get("node").one("#"+i.getSelected()).removeAttribute("fill"),i.select();return}if(t.one("#"+e.currentTarget.getAttribute("id")))return;e.stopPropagation(),i.insertSnippet(e.currentTarget.getAttribute("id"),i.removeSnippet(t.getAttribute("id"))),i.select(),this.render()},".mathslate_dnd",this);var t=new e.DD.Delegate({container:a,moveOnEnd:!1,nodes:".mathslate_dnd"});e.DD.DDM.on("drag:start",function(e){var t=e.target;t.get("node").hasClass("mathslate_dnd")&&(t.get("node").addClass(s.DRAGGEDNODE),t.get("dragNode").addClass(s.DRAGNODE),t.get("dragNode").all("> span").pop().setStyle("opacity","1"))}),e.DD.DDM.on("drag:end",function(e){var t=e.target;t.get("node").hasClass("mathslate_dnd")&&(t.get("node").removeClass(s.DRAGGEDNODE),t.get("node").removeAttribute("mathcolor"),t.get("node").removeAttribute("stroke"),t.get("dragNode").all("> span").pop().setStyle("opacity","0"),t.get("dragNode").setStyles({top:0,left:0}),e.stopPropagation())}),this.workspace.all(".mathslate_dnd").each(function(t){new e.DD.Drop
({node:t})}),e.DD.DDM.on("drop:hit",function(e){if(!e.target.get("node").hasClass("mathslate_dnd"))return;var t=e.drag.get("node").get("id"),n=e.target.get("node").getAttribute("id");if(e.drag.get("data"))i.insertSnippet(n,i.createItem(e.drag.get("data")));else{if(t===n||!i.isItem(t)||!!f.one("#"+t).one("#"+n))return;i.insertSnippet(e.drop.get("node").get("id"),i.removeSnippet(t))}e.stopPropagation(),this.render()},this),e.DD.DDM.on("drop:enter",function(e){if(!e.target.get("node").hasClass("mathslate_dnd"))return;e.stopPropagation();var t=e.target.get("node").getAttribute("id");l.get("node").all(o.HIGHLIGHT).removeAttribute("mathcolor").removeAttribute("stroke").removeAttribute("fill").removeClass(s.HIGHLIGHT),a.all(o.HIGHLIGHT).removeClass(s.HIGHLIGHT),a.one("#"+t)&&a.one("#"+t).addClass(s.HIGHLIGHT),l.get("node").one("#"+t).addClass(s.HIGHLIGHT),l.get("node").one("#"+t).setAttribute("mathcolor","yellow").setAttribute("stroke","yellow").setAttribute("fill","yellow")}),e.DD.DDM.on("drop:exit",function(e){if(!e.target.get("node")||!e.target.get("node").hasClass("mathslate_dnd"))return;var t=e.target.get("node").getAttribute("id");l.get("node").one("#"+t).test(s.HIGHLIGHT)?(l.get("node").one("#"+t).removeAttribute("mathcolor").removeAttribute("stroke").removeAttribute("fill").removeClass(s.HIGHLIGHT),e.target.get("node").removeClass(s.HIGHLIGHT),l.get("node").all("#"+t+"[stroke=yellow]").removeAttribute("fill").removeAttribute("stroke"),l.get("node").all("#"+t+"[mathcolor=yellow]").removeAttribute("mathcolor")):(e.target.get("node").addClass(s.HIGHLIGHT),l.get("node").one("#"+t).setAttribute("mathcolor","yellow").setAttribute("stroke","yellow").setAttribute("fill","yellow").addClass(s.HIGHLIGHT),e.stopPropagation())})},this.makeDrops=function(){u=e.Node.create("<span></span>"),u.setHTML(i.preview().replace(/div/g,"span").replace(/<\/*br>/g,"")),e.one(t).appendChild(u),u.all("span").each(function(t){if(!l.get("node").one("#"+t.getAttribute("id")))return;t.appendChild('<span style="position: relative; opacity: 0"><math display="inline">'+this.toMathML([e.JSON.parse(i.getItemByID(t.getAttribute("id")))]).replace(/id="[^"]*"/,"")+"</math></span>"),t.setAttribute("style","position: absolute; top: 0; left: 0; margin: 0px; z-index: +1")},this),u.all("span").each(function(e){if(!l.get("node").one("#"+e.getAttribute("id")))return;var t=l.get("node").one("#"+e.getAttribute("id")).getDOMNode().getBoundingClientRect(),n=e.getDOMNode().getBoundingClientRect();e.setStyle("top",t.top-n.top),e.setStyle("left",t.left-n.left),e.setStyle("width",t.width),e.setStyle("height",t.height)}),r.Hub.Queue(["Typeset",r.Hub,u.getDOMNode()])},this.makeDrops=function(){u=document.createElement("span"),u.innerHTML=i.preview().replace(/div/g,"span").replace(/<\/*br>/g,""),e.one(t).appendChild(u);var n=u.getElementsByTagName("span");for(var s=0;s<n.length;s++){var o=n.item(s);if(l.get("node").one("#"+o.id)){var a=document.createElement("span");a.setAttribute("style","position: relative; opacity: 0"),a.innerHTML='<math display="inline">'+this.toMathML([e.JSON.parse(i.getItemByID(o.getAttribute("id")))]).replace(/id="[^"]*"/,"")+"</math>",o.appendChild(a),o.setAttribute("style","position: absolute; top: 4.75px; left: 1.25px; margin: 0px; z-index: +1");var f=l.get("node").one("#"+o.id).getDOMNode().getBoundingClientRect(),c=o.getBoundingClientRect();o.setAttribute("style","position: absolute; top: "+(f.top-c.top).toString()+"px; left: "+(f.left-c.left).toString()+"px; z-index: +1")}}r.Hub.Queue(["Typeset",r.Hub,u]),u=e.one(u)},r.Hub.Register.StartupHook("Snippet Editor Ready",[function(e){i=new r.Mathslate.mSlots,i.slots.push(e.math),e.render()},this]),h.on("click",this.redo,this),c.on("click",this.undo,this),p.on("click",this.clear,this),d.on("click",function(){f.setHTML('<iframe src="'+n.help+'" style="width: '+f.getStyle("width")+'" class="'+s.HELPBOX+'"/>')})}},"@VERSION@",{requires:["drag-delegate","dd-drop"]});
